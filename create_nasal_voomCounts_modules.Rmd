---
title: "Create Nasal Voom Counts and Modules"
author: "Elizabeth Whalen"
date: "9/17/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Optionally install, and load required libraries
```{r loadLibraries}

# Determine missing Bioconductor packages and install
BioCPackages <- c("edgeR", "biomaRt")
new.packages <- BioCPackages[!(BioCPackages %in% installed.packages()[,"Package"])]
if(length(new.packages)) {
  source("http://bioconductor.org/biocLite.R")
  biocLite(new.packages)
}
 
# Determine missing CRAN Packages and install
CRANPackages <- c("WGCNA")
new.packages <- CRANPackages[!(CRANPackages %in% installed.packages()[,"Package"])]
if(length(new.packages)) {
  install.packages(new.packages)
}

# Load libraries....
library(edgeR)
library(biomaRt)
library(WGCNA)
```
## Read in Data

```{r readData}

dataDir <- "data"
resultsDir <- "results"

# read in raw counts - this is the GEO submission
nCountData<-read.delim(file=file.path(dataDir, "raw_counts_nasal_muppits420.txt"), sep=",", row.names=1)

# read in design file for GEO
nDesign<-read.csv(file=file.path(dataDir, "nasalDesign_updated_forGEO.csv"))

all(colnames(nCountData) == nDesign$title)

# use this file to get the 146 libs that went into nasal mod construction
allNasalDesignOld<-read.csv(file=file.path(dataDir, "allNasalDesign.csv"))

```

## Filter Rows

All of phase 1/flow cell 1 are currently in the GEO data set. For phase 2/flow cell 2 we need to add some replicate libraries in to do the filtering the same as was previously done.

```{r filterRows}

##########
# Phase/Flow Cell 1
##########
# use the old set to get 146 libs for module construction
modLibs<-allNasalDesignOld$library.sampleId

# subset to just these libraries for module construction
nDesignSub<-nDesign[match(modLibs, nDesign$title),]
nCountDataSub<-nCountData[, match(modLibs, nDesign$title)]
all(colnames(nCountDataSub) == nDesignSub$title)

# split into batch 1/phase 1
nDesignSub1<-nDesignSub[which(nDesignSub$Characteristics..Flowcell=="BC893JANXX"),]
nCountDataSub1<-nCountDataSub[, which(nDesignSub$Characteristics..Flowcell=="BC893JANXX")]
all(colnames(nCountDataSub1) == nDesignSub1$title)

d1<-DGEList(counts=nCountDataSub1)
d1<-calcNormFactors(d1)

keepRows1<-rowSums(round(cpm(d1$counts)) >= 1) >= 0.1*ncol(nCountDataSub1)
table(keepRows1)	# removes 44,931 rows

curDGENasal1<-d1[keepRows1,]	# now have 19,322 rows
curDGENasal1<-calcNormFactors(curDGENasal1)

mart = useMart(host='oct2016.archive.ensembl.org', biomart='ENSEMBL_MART_ENSEMBL', dataset="hsapiens_gene_ensembl")
resultsBio1<-getBM(attributes=c("ensembl_gene_id", "hgnc_symbol","gene_biotype"), filters="ensembl_gene_id", values=rownames(curDGENasal1), mart=mart)
resultsBioProtein1<-resultsBio1[which(resultsBio1$gene_biotype=="protein_coding"),]
keepIndex1<-which(rownames(curDGENasal1) %in% resultsBioProtein1$ensembl_gene_id)
length(keepIndex1) # 14,057 (same as before)

curDGENasal1<-curDGENasal1[keepIndex1,]
dim(curDGENasal1)	# 14057    41
curDGENasal1<-calcNormFactors(curDGENasal1)



##########
# Phase/Flow Cell 2
# will need to add this to GEO submission
##########
# read in original data and do QC
counts<-read.csv(file=file.path(dataDir, "P90-19_C95GDANXX_160808_combined_counts.csv"), row.names=1)
metrics<-read.csv(file=file.path(dataDir, "P90-19_C95GDANXX_160808_combined_metrics.csv"))
design<-read.csv(file=file.path(dataDir, "P90-19_Final Annotation.csv"))
design<-design[1:180,]

newCN<-colnames(counts)
newCN<-unlist(lapply(strsplit(newCN, "_"), function(x) {x[1]}))
colnames(counts)<-newCN

metrics$Library.ID<-unlist(lapply(strsplit(as.character(metrics$libId), "_"), function(x) {x[1]}))
design$libID<-as.character(design$libID)

# now check the order - yes, all match
all(metrics$Library.ID==colnames(counts))
all(metrics$Library.ID==design$libID)

totalCounts<-apply(counts, 2, sum)

######
# filter libs 
######
curCol<-rep("black", nrow(metrics))
curCol[which(totalCounts/1E6 < 0.3)]<-"red"
curCol[which(curCol=="black" & metrics$MEDIAN_CV_COVERAGE > 1)]<-"blue"
curCol[which(curCol=="black" & metrics$mapped_reads_w_dups < 0.78)]<-"blue"

keepIndex<-which(curCol=="black")
designSub<-design[keepIndex,]
countSub<-counts[,keepIndex]
metricSub<-metrics[keepIndex,]
totalCountsSub<-totalCounts[keepIndex]

dim(countSub) # 142 samples went into phase 2 filtering

table(colnames(countSub) %in% nDesign$title) # 22 of these libraries are not in the GEO submission currently (120 are)
table(nDesign$Characteristics..Flowcell[match(designSub$library.sampleId, nDesign$title)]) # 120 libraries come from flow cell AC95GDANXX

d2<-DGEList(counts=countSub)
d2<-calcNormFactors(d2)

keepRows2<-rowSums(round(cpm(d2$counts)) >= 1) >= 0.1*ncol(countSub)
table(keepRows2)	# removes 45,776 rows

curDGENasal2<-d2[keepRows2,]	# now have 18,477 rows

mart = useMart(host='oct2016.archive.ensembl.org', biomart='ENSEMBL_MART_ENSEMBL', dataset="hsapiens_gene_ensembl")
resultsBio2<-getBM(attributes=c("ensembl_gene_id", "hgnc_symbol","gene_biotype"), filters="ensembl_gene_id", values=rownames(curDGENasal2), mart=mart)
resultsBioProtein2<-resultsBio2[which(resultsBio2$gene_biotype=="protein_coding"),]
keepIndex2<-which(rownames(curDGENasal2) %in% resultsBioProtein2$ensembl_gene_id)
length(keepIndex2) # 13,928 (same as before)

curDGENasal2<-curDGENasal2[keepIndex2,]
dim(curDGENasal2)	# 13928   142

```

## Run Voom

Run voom on each phase separately.

```{r runVoom}

### PHASE 1
# make sure we have factors set up correctly
# for phase 1 my previous DGE object matches this one exactly (counts and norm.factors)
nDesignSub1$Visit<-as.character(nDesignSub1$Characteristics..Analysis.Visit)
nDesignSub1$Visit[which(nDesignSub1$Visit %in% c("Visit 1a","Visit 2a"))]<-"Visit A"
nDesignSub1$Visit[which(nDesignSub1$Visit %in% c("Visit 1b","Visit 2b"))]<-"Visit B"
table(nDesignSub1$Visit)
nDesignSub1$Visit<-factor(nDesignSub1$Visit, levels=c("Visit 0","Visit A","Visit B"))

curMM<-model.matrix(~Visit, data=nDesignSub1)
nasalVoom1<-voomWithQualityWeights(curDGENasal1, curMM, plot=TRUE)

# now need to take into account duplicate correlation
nDesignSub1$Source.name<-as.factor(as.character(nDesignSub1$Source.name))
corfit<-duplicateCorrelation(nasalVoom1, curMM, block=nDesignSub1$Source.name)
corfit$consensus.correlation	# 0.2562075

# matches the values from the original processing
newNasalVoom1<-voomWithQualityWeights(curDGENasal1, curMM, plot=TRUE, block=nDesignSub1$Patient.ID, correlation=corfit$consensus)

### PHASE 2
# this is where I'm not getting identical results
# the counts are identical, but the norm factors aren't the same in the DGE object - why?
# make sure we have factors set up correctly
nDesignSub2<-designSub
nDesignSub2$Visit<-as.character(nDesignSub2$Visit..)
nDesignSub2$Visit[which(nDesignSub2$Visit=="Visit 0 - Screening and Enrollment")]<-"Visit 0"
nDesignSub2$Visit[which(nDesignSub2$Visit %in% c("Visit 1a","Visit 2a"))]<-"Visit A"
nDesignSub2$Visit[which(nDesignSub2$Visit %in% c("Visit 1b","Visit 2b"))]<-"Visit B"
table(nDesignSub2$Visit)
nDesignSub2$Visit<-factor(nDesignSub2$Visit, levels=c("Visit 0","Visit A","Visit B"))

curMM<-model.matrix(~Visit, data=nDesignSub2)
nasalVoom2<-voomWithQualityWeights(curDGENasal2, curMM, plot=TRUE)

# now need to take into account duplicate correlation
nDesignSub2$Patient.ID<-as.factor(as.character(nDesignSub2$Patient.ID))
corfit2<-duplicateCorrelation(nasalVoom2, curMM, block=nDesignSub2$Patient.ID)
corfit2$consensus.correlation	# 0.340055

newNasalVoom2<-voomWithQualityWeights(curDGENasal2, curMM, plot=TRUE, block=nDesignSub2$Patient.ID, correlation=corfit2$consensus)


# Combine Voom Counts
newNasalVoom1sub<-newNasalVoom1[which(rownames(newNasalVoom1) %in% rownames(newNasalVoom2)),]
newNasalVoom2sub<-newNasalVoom2[which(rownames(newNasalVoom2) %in% rownames(newNasalVoom1)),]
dim(newNasalVoom1sub)
dim(newNasalVoom2sub)
sum(rownames(newNasalVoom1sub) %in% rownames(newNasalVoom2sub))
newNasalVoom1sub<-newNasalVoom1sub[match(rownames(newNasalVoom2sub), rownames(newNasalVoom1sub)),]
all(rownames(newNasalVoom1sub) == rownames(newNasalVoom2sub))

modNasalVoom<-cbind(newNasalVoom1sub, newNasalVoom2sub)
# subset modNasalVoom to the 146 libs in nDesignSub
keepLibs<-which(colnames(modNasalVoom) %in% nDesignSub$title)
modNasalVoomOrig<-modNasalVoom
modNasalVoom<-modNasalVoomOrig[,keepLibs]

all(colnames(modNasalVoom)==nDesignSub$title)

modNDesign<-nDesignSub
all(colnames(modNasalVoom)==modNDesign$title)

# need to write out this information
phase1libs<-colnames(newNasalVoom1)
phase2libs<-colnames(newNasalVoom2)
libsUsedInModuleConstruction<-colnames(modNasalVoom)
libsList<-list(phase1libs=phase1libs, phase2libs=phase2libs, libsUsedInModuleConstruction=libsUsedInModuleConstruction)
# write out to file
#save(libsList, list="libsList", file="results/libsList.Rdata")

```

## Reset Cell Percentages

When the modules were created, we did not have cell percentages for visit B so visit B percentages were set to visit A percentages.

```{r resetCellPerc}

neut<-modNDesign$Characteristics..Nasal.Neutrophil.Percentage 
lymp<-modNDesign$Characteristics..Nasal.Lymphocyte.Percentage 
eos<-modNDesign$Characteristics..Nasal.Eosinophil.Percentage 
mac<-modNDesign$Characteristics..Nasal.Macrophage.Percentage 
epi<-modNDesign$Characteristics..Nasal.Epithelial.Percentage
squa<-modNDesign$Characteristics..Nasal.Squamous.Percentage

uniIndivs<-unique(as.character(modNDesign$Source.name))
for (i in 1:length(uniIndivs))
{
  matchIndex<-which(uniIndivs[i]==modNDesign$Source.name)
  matchVisit<-as.character(modNDesign$Characteristics..Analysis.Visit[matchIndex])
  if (length(grep("b", matchVisit)) > 0)
  {
    # find out which visit it is
    visitNum<-substr(matchVisit[grep("b", matchVisit)], 7, 7)
    if (length(visitNum)==2)
    {
      # have both visits 1 and 2
      if (any(matchVisit=="Visit 1a"))
      {
        # only get the a visit from the full set
        bIndex<-which(uniIndivs[i]==modNDesign$Source.name & modNDesign$Characteristics..Analysis.Visit=="Visit 1b")
        aIndex<-which(uniIndivs[i]==modNDesign$Source.name & modNDesign$Characteristics..Analysis.Visit=="Visit 1a")
        neut[bIndex]<-neut[aIndex]
        lymp[bIndex]<-lymp[aIndex]
        eos[bIndex]<-eos[aIndex]
        mac[bIndex]<-mac[aIndex]
        epi[bIndex]<-epi[aIndex]
        squa[bIndex]<-squa[aIndex]
      }
      if (!("Visit 1a" %in% matchVisit))
      {
        bIndex<-which(uniIndivs[i]==modNDesign$Source.name & modNDesign$Characteristics..Analysis.Visit=="Visit 1b")
        neut[bIndex]<-NA
        lymp[bIndex]<-NA
        eos[bIndex]<-NA
        mac[bIndex]<-NA
        epi[bIndex]<-NA
        squa[bIndex]<-NA
      }
      
      if (any(matchVisit=="Visit 2a"))
      {
        # only get the a visit from the full set
        bIndex<-which(uniIndivs[i]==modNDesign$Source.name & modNDesign$Characteristics..Analysis.Visit=="Visit 2b")
        aIndex<-which(uniIndivs[i]==modNDesign$Source.name & modNDesign$Characteristics..Analysis.Visit=="Visit 2a")
        neut[bIndex]<-neut[aIndex]
        lymp[bIndex]<-lymp[aIndex]
        eos[bIndex]<-eos[aIndex]
        mac[bIndex]<-mac[aIndex]
        epi[bIndex]<-epi[aIndex]
        squa[bIndex]<-squa[aIndex]
      }
      if (!("Visit 2a" %in% matchVisit))
      {
        bIndex<-which(uniIndivs[i]==modNDesign$Source.name & modNDesign$Characteristics..Analysis.Visit=="Visit 2b")
        neut[bIndex]<-NA
        lymp[bIndex]<-NA
        eos[bIndex]<-NA
        mac[bIndex]<-NA
        epi[bIndex]<-NA
        squa[bIndex]<-NA
      }
    }
    else
    {
      otherVisit<-paste("Visit ",visitNum,"a", sep="")
      if (any(matchVisit==otherVisit))
      {
        # only get the a visit from the full set
        bIndex<-which(uniIndivs[i]==modNDesign$Source.name & modNDesign$Characteristics..Analysis.Visit==paste("Visit ",visitNum,"b", sep=""))
        aIndex<-which(uniIndivs[i]==modNDesign$Source.name & modNDesign$Characteristics..Analysis.Visit==paste("Visit ",visitNum,"a", sep=""))
        neut[bIndex]<-neut[aIndex]
        lymp[bIndex]<-lymp[aIndex]
        eos[bIndex]<-eos[aIndex]
        mac[bIndex]<-mac[aIndex]
        epi[bIndex]<-epi[aIndex]
        squa[bIndex]<-squa[aIndex]
      }
      else
      {
        # there's no matching visit A for this visit B so need to set to NA
        bIndex<-which(uniIndivs[i]==modNDesign$Source.name & modNDesign$Characteristics..Analysis.Visit==paste("Visit ",visitNum,"b", sep=""))
        neut[bIndex]<-NA
        lymp[bIndex]<-NA
        eos[bIndex]<-NA
        mac[bIndex]<-NA
        epi[bIndex]<-NA
        squa[bIndex]<-NA
      }
    }
  }
}
# there were a few visit A values for visit B that we had back in 2016 so will use those from the full set
# and some were missing so need to rearrange some values

# problem: the cell percentages don't match exactly yet - different missing values
# eventually will remove nasalDesign from final version
nasalDesign<-read.csv(file=file.path(dataDir, "newNasalDesign.csv"))
all(as.character(nasalDesign$library.sampleId)==as.character(modNDesign$title))
neutOrig<-nasalDesign$Neutrophil * (nasalDesign$WBC / 100)
# these need to be set to NA
which(is.na(neutOrig))[!(which(is.na(neutOrig)) %in% which(is.na(neut)))] # 92  93 130 131 137 145 146 - TO DO: change hard coding index to match by library ID - DONE
neut[which(modNDesign$title %in% c("lib12437", "lib12438", "lib12502", "lib12503", "lib12524", "lib12535", "lib12536"))]<-NA
# these NAs need to be converted to numbers
which(is.na(neut))[!(which(is.na(neut)) %in% which(is.na(neutOrig)))] # 13  48  81 102
setToNumberIndex<-which(modNDesign$title %in% c("lib11094", "lib12366", "lib12416", "lib12456")) # these are all visit 1b
for (i in 1:length(setToNumberIndex))
{
  curIndex<-setToNumberIndex[i]
  curIndiv<-as.character(modNDesign$Source.name[curIndex])
  matchIndex<-which(curIndiv==nDesign$Source.name & nDesign$Characteristics..Analysis.Visit=="Visit 1a")
  neut[curIndex]<-nDesign$Characteristics..Nasal.Neutrophil.Percentage[matchIndex]
}

lympOrig<-nasalDesign$Lymphocyte * (nasalDesign$WBC / 100)
which(is.na(lympOrig))[!(which(is.na(lympOrig)) %in% which(is.na(lymp)))] # 92  93 130 131 137 145 146
lymp[which(modNDesign$title %in% c("lib12437", "lib12438", "lib12502", "lib12503", "lib12524", "lib12535", "lib12536"))]<-NA
# these NAs need to be converted to numbers
which(is.na(lymp))[!(which(is.na(lymp)) %in% which(is.na(lympOrig)))] # 13  48  81 102
setToNumberIndex<-which(modNDesign$title %in% c("lib11094", "lib12366", "lib12416", "lib12456")) # these are all visit 1b
for (i in 1:length(setToNumberIndex))
{
  curIndex<-setToNumberIndex[i]
  curIndiv<-as.character(modNDesign$Source.name[curIndex])
  matchIndex<-which(curIndiv==nDesign$Source.name & nDesign$Characteristics..Analysis.Visit=="Visit 1a")
  lymp[curIndex]<-nDesign$Characteristics..Nasal.Lymphocyte.Percentage[matchIndex]
}

eosOrig<-nasalDesign$Eosinophil * (nasalDesign$WBC / 100)
which(is.na(eosOrig))[!(which(is.na(eosOrig)) %in% which(is.na(eos)))] # 92  93 130 131 137 145 146
eos[which(modNDesign$title %in% c("lib12437", "lib12438", "lib12502", "lib12503", "lib12524", "lib12535", "lib12536"))]<-NA
# these NAs need to be converted to numbers
which(is.na(eos))[!(which(is.na(eos)) %in% which(is.na(eosOrig)))] # 13  48  81 102
setToNumberIndex<-which(modNDesign$title %in% c("lib11094", "lib12366", "lib12416", "lib12456")) # these are all visit 1b
for (i in 1:length(setToNumberIndex))
{
  curIndex<-setToNumberIndex[i]
  curIndiv<-as.character(modNDesign$Source.name[curIndex])
  matchIndex<-which(curIndiv==nDesign$Source.name & nDesign$Characteristics..Analysis.Visit=="Visit 1a")
  eos[curIndex]<-nDesign$Characteristics..Nasal.Eosinophil.Percentage[matchIndex]
}

macOrig<-nasalDesign$Macrophage * (nasalDesign$WBC / 100)
which(is.na(macOrig))[!(which(is.na(macOrig)) %in% which(is.na(mac)))] # 92  93 130 131 137 145 146
mac[which(modNDesign$title %in% c("lib12437", "lib12438", "lib12502", "lib12503", "lib12524", "lib12535", "lib12536"))]<-NA
# these NAs need to be converted to numbers
which(is.na(mac))[!(which(is.na(mac)) %in% which(is.na(macOrig)))] # 13  48  81 102
setToNumberIndex<-which(modNDesign$title %in% c("lib11094", "lib12366", "lib12416", "lib12456")) # these are all visit 1b
for (i in 1:length(setToNumberIndex))
{
  curIndex<-setToNumberIndex[i]
  curIndiv<-as.character(modNDesign$Source.name[curIndex])
  matchIndex<-which(curIndiv==nDesign$Source.name & nDesign$Characteristics..Analysis.Visit=="Visit 1a")
  mac[curIndex]<-nDesign$Characteristics..Nasal.Macrophage.Percentage[matchIndex]
}

epiOrig<-nasalDesign$Epithelial
which(is.na(epiOrig))[!(which(is.na(epiOrig)) %in% which(is.na(epi)))] # DIFFERENT! 92  93 145 146
epi[which(modNDesign$title %in% c("lib12437", "lib12438", "lib12535", "lib12536"))]<-NA
# these NAs need to be converted to numbers
which(is.na(epi))[!(which(is.na(epi)) %in% which(is.na(epiOrig)))] # DIFFERENT! 13  38  48  81  84 102 (new are: 38, 84)
setToNumberIndex<-which(modNDesign$title %in% c("lib11094", "lib11122", "lib12366", "lib12416", "lib12428", "lib12456")) # these are all visit 1b
for (i in 1:length(setToNumberIndex))
{
  curIndex<-setToNumberIndex[i]
  curIndiv<-as.character(modNDesign$Source.name[curIndex])
  matchIndex<-which(curIndiv==nDesign$Source.name & nDesign$Characteristics..Analysis.Visit=="Visit 1a")
  epi[curIndex]<-nDesign$Characteristics..Nasal.Epithelial.Percentage[matchIndex]
}

squaOrig<-nasalDesign$Squamous
which(is.na(squaOrig))[!(which(is.na(squaOrig)) %in% which(is.na(squa)))] # DIFFERENT! 92  93 145 146
squa[which(modNDesign$title %in% c("lib12437", "lib12438", "lib12535", "lib12536"))]<-NA
# these NAs need to be converted to numbers
which(is.na(squa))[!(which(is.na(squa)) %in% which(is.na(squaOrig)))] # DIFFERENT! 13  38  48  81  84 102 (new are: 38, 84)
setToNumberIndex<-which(modNDesign$title %in% c("lib11094", "lib11122", "lib12366", "lib12416", "lib12428", "lib12456")) # these are all visit 1b
for (i in 1:length(setToNumberIndex))
{
  curIndex<-setToNumberIndex[i]
  curIndiv<-as.character(modNDesign$Source.name[curIndex])
  matchIndex<-which(curIndiv==nDesign$Source.name & nDesign$Characteristics..Analysis.Visit=="Visit 1a")
  squa[curIndex]<-nDesign$Characteristics..Nasal.Squamous.Percentage[matchIndex]
}

```

## Assign to Cell Type

```{r assignCellType}

neutP<-c()
neutCor<-c()
lympP<-c()
lympCor<-c()
eosP<-c()
eosCor<-c()
macP<-c()
macCor<-c()
epiP<-c()
epiCor<-c()
squaP<-c()
squaCor<-c()
for (i in 1:nrow(modNasalVoom))
{
  corVals<-cor.test(modNasalVoom$E[i,], neut, use="pairwise.complete.obs")
  neutP<-c(neutP, corVals$p.value)
  neutCor<-c(neutCor, corVals$estimate)
  
  corVals<-cor.test(modNasalVoom$E[i,], lymp, use="pairwise.complete.obs")
  lympP<-c(lympP, corVals$p.value)
  lympCor<-c(lympCor, corVals$estimate)

  corVals<-cor.test(modNasalVoom$E[i,], eos, use="pairwise.complete.obs")
  eosP<-c(eosP, corVals$p.value)
  eosCor<-c(eosCor, corVals$estimate)
  
  corVals<-cor.test(modNasalVoom$E[i,], mac, use="pairwise.complete.obs")
  macP<-c(macP, corVals$p.value)
  macCor<-c(macCor, corVals$estimate)
  
  corVals<-cor.test(modNasalVoom$E[i,], epi, use="pairwise.complete.obs")
  epiP<-c(epiP, corVals$p.value)
  epiCor<-c(epiCor, corVals$estimate)
  
  corVals<-cor.test(modNasalVoom$E[i,], squa, use="pairwise.complete.obs")
  squaP<-c(squaP, corVals$p.value)
  squaCor<-c(squaCor, corVals$estimate)
}

# adjust p-values
neutFDR<-p.adjust(neutP)
lympFDR<-p.adjust(lympP)
eosFDR<-p.adjust(eosP)
macFDR<-p.adjust(macP)
epiFDR<-p.adjust(epiP)
squaFDR<-p.adjust(squaP)

# what were the cutoffs for assignment to cell type?
# exact match
sum(neutFDR < 0.05 & neutCor > 0) # 1525
sum(lympFDR < 0.05 & lympCor > 0) # 1192
sum(eosFDR < 0.05 & eosCor > 0) # 672
sum(macFDR < 0.05 & macCor > 0) # 788
sum(epiFDR < 0.05 & epiCor > 0) # 241
sum(squaFDR < 0.05 & squaCor > 0) # 1058

neutGenes<-rownames(modNasalVoom)[which(neutFDR < 0.05 & neutCor > 0)]
lympGenes<-rownames(modNasalVoom)[which(lympFDR < 0.05 & lympCor > 0)]
eosGenes<-rownames(modNasalVoom)[which(eosFDR < 0.05 & eosCor > 0)]
macGenes<-rownames(modNasalVoom)[which(macFDR < 0.05 & macCor > 0)]
epiGenes<-rownames(modNasalVoom)[which(epiFDR < 0.05 & epiCor > 0)]
squaGenes<-rownames(modNasalVoom)[which(squaFDR < 0.05 & squaCor > 0)]
unmaGenes<-rownames(modNasalVoom)[which(!(rownames(modNasalVoom) %in% unique(c(neutGenes, lympGenes, eosGenes, macGenes, epiGenes, squaGenes))))]

```

## Now Run WGCNA

```{r runWGCNA}

# subset to cell specific genes
#matchIndex<-match(neutGenes, rownames(modNasalVoom))
#matchIndex<-match(lympGenes, rownames(modNasalVoom))
#matchIndex<-match(eosGenes, rownames(modNasalVoom))
#matchIndex<-match(macGenes, rownames(modNasalVoom))
#matchIndex<-match(epiGenes, rownames(modNasalVoom))
#matchIndex<-match(squaGenes, rownames(modNasalVoom))
matchIndex<-match(unmaGenes, rownames(modNasalVoom))

setVoom<-modNasalVoom[matchIndex,]
# power for
# neut - 12
# lymp - 12
# eos - 8
# mac - 12
# epi - 12
# squa - 12
# unassigned - 10

powers<-c(1:10,seq(12,30,2))
# call the network topology analysis function
sft<-pickSoftThreshold(t(setVoom$E), powerVector=powers, verbose=5)
# plot the results
par(mfrow=c(1,2))
# scale-free topology fit index as a function of the soft-thresholding power
plot(sft$fitIndices[,1], -sign(sft$fitIndices[,3])*sft$fitIndices[,2], xlab="Soft Threshold (power)", ylab="Scale Free Topology Model Fit,signed R^2", type="n", main=paste("Scale independence"))
text(sft$fitIndices[,1], -sign(sft$fitIndices[,3])*sft$fitIndices[,2], labels=powers, col="red")
# this line corresponds to using a R^2 cutoff of h
abline(h=0.9, col="red")
# mean connectivity as a function of the soft-thresholding power
plot(sft$fitIndices[,1], sft$fitIndices[,5], xlab="Soft Threshold (power)", ylab="Mean Connectivity", type="n", main=paste("Mean Connectivity"))
text(sft$fitIndices[,1], sft$fitIndices[,5], labels=powers, col="red")

createWGCNA<-function(cellGenes, allNasalVoom, curPower)
{
	matchIndex<-match(cellGenes, rownames(allNasalVoom))
	setVoom<-allNasalVoom[matchIndex,]
	setVoom<-setVoom[order(rownames(setVoom)),]
	
	time1<-Sys.time()
	voomNetNasal<-blockwiseModules(t(setVoom$E), power=curPower, networkType="signed", TOMType="signed", minModuleSize=30, maxBlockSize=6000, saveTOMS=TRUE, saveTOMFileBase = "test", deepSplit=4, numericLabels=TRUE, minCoreKME=0.7, minKMEtoStay=0.5)
	time2<-Sys.time()
	print(time2-time1)	# 10 sec, 7 sec, 4 sec, 5 sec, 3 sec, 7 sec, 42 sec
	return(voomNetNasal)
}
# 6 neut, 4 lymp, 5 eos, 4 mac, 1 epi, 1 squa, 31 for unmatched
neutrophilWGCNA<-createWGCNA(neutGenes, modNasalVoom, curPower=12)
lymphocyteWGCNA<-createWGCNA(lympGenes, modNasalVoom, curPower=12)
eosinophilWGCNA<-createWGCNA(eosGenes, modNasalVoom, curPower=8)
macrophageWGCNA<-createWGCNA(macGenes, modNasalVoom, curPower=12)
epithelialWGCNA<-createWGCNA(epiGenes, modNasalVoom, curPower=12)
squamousWGCNA<-createWGCNA(squaGenes, modNasalVoom, curPower=12)
unmatchedWGCNA<-createWGCNA(unmaGenes, modNasalVoom, curPower=10)

# now how to store it
# need to order the gene names because that was done in the function createWGCNA
neutSet<-cbind(rep("neutrophil", length(neutGenes)), neutGenes[order(neutGenes)], paste("neut",neutrophilWGCNA$colors,sep=""))
lympSet<-cbind(rep("lymphocyte", length(lympGenes)), lympGenes[order(lympGenes)], paste("lymp",lymphocyteWGCNA$colors,sep=""))
eosSet<-cbind(rep("eosinophil", length(eosGenes)), eosGenes[order(eosGenes)], paste("eos",eosinophilWGCNA$colors,sep=""))
macSet<-cbind(rep("macrophage", length(macGenes)), macGenes[order(macGenes)], paste("mac",macrophageWGCNA$colors,sep=""))
epiSet<-cbind(rep("epithelial", length(epiGenes)), epiGenes[order(epiGenes)], paste("epi",epithelialWGCNA$colors,sep=""))
squaSet<-cbind(rep("squamous", length(squaGenes)), squaGenes[order(squaGenes)], paste("squa",squamousWGCNA$colors,sep=""))
unmaSet<-cbind(rep("unassigned", length(unmaGenes)), unmaGenes[order(unmaGenes)], paste("unma",unmatchedWGCNA$colors,sep=""))

allSets<-rbind(neutSet, lympSet, eosSet, macSet, epiSet, squaSet, unmaSet)
table(allSets[,3])

colnames(allSets)<-c("cellType","ensemblID","geneSet")
allSets<-as.data.frame(allSets)
# now add gene symbols
allSets$symbol<-""
for (i in 1:nrow(allSets))
{
  curID<-as.character(allSets$ensemblID[i])
  allSets$symbol[i]<-as.character(resultsBioProtein1$hgnc_symbol[which(curID==resultsBioProtein1$ensembl_gene_id)  ])
}

# Write out the nasal modules as a .csv file.
write.csv(allSets[allSets$cellType == "neutrophil", ], file=file.path(resultsDir, "neutrophilNasalModules.csv"), quote=F, row.names=F)
write.csv(allSets[allSets$cellType == "lymphocyte", ], file=file.path(resultsDir, "lymphocyteNasalModules.csv"), quote=F, row.names=F)
write.csv(allSets[allSets$cellType == "eosinophil", ], file=file.path(resultsDir, "eosinophilNasalModules.csv"), quote=F, row.names=F)
write.csv(allSets[allSets$cellType == "macrophage", ], file=file.path(resultsDir, "macrophageNasalModules.csv"), quote=F, row.names=F)
write.csv(allSets[allSets$cellType == "epithelial", ], file=file.path(resultsDir, "epithelialNasalModules.csv"), quote=F, row.names=F)
write.csv(allSets[allSets$cellType == "squamous",   ], file=file.path(resultsDir, "squamousNasalModules.csv"),   quote=F, row.names=F)
write.csv(allSets[allSets$cellType == "unassigned", ], file=file.path(resultsDir, "unassignedNasalModules.csv"), quote=F, row.names=F)
write.csv(allSets, file=file.path(resultsDir, "allNasalModules.csv"), quote=F, row.names=F)
```
